<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PhotoMapperAI.UI.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="PhotoMapperAI.UI.Views.ExtractStepView"
             x:DataType="vm:ExtractStepViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Design.DataContext>
    <vm:ExtractStepViewModel/>
  </Design.DataContext>

  <ScrollViewer>
    <StackPanel Margin="16" Spacing="12">
      <!-- Header -->
      <TextBlock Text="Step 1: Extract Player Data" 
                 FontSize="20" FontWeight="Bold" 
                 Foreground="{DynamicResource PrimaryBrush}"/>
      <TextBlock Text="Extract player data from your database to a CSV file. This CSV will be used in the next steps."
                 FontSize="13" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>

      <Separator Margin="0,4" Background="{DynamicResource DividerBrush}"/>

      <!-- 1. Database Connection -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ” Database Connection" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Select a file containing your database connection string (kept separate for security)"
                      FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <Grid Grid.Column="0" ColumnDefinitions="*,Auto">
              <TextBox Grid.Column="0" Text="{Binding ConnectionStringPath}" 
                       Watermark="Path to connection string file..."
                       IsReadOnly="True" Height="32"
                       Background="{DynamicResource InputBackgroundBrush}"
                       Foreground="{DynamicResource PrimaryTextBrush}"/>
              <Button Grid.Column="1" Content="Browse" 
                      Click="BrowseConnectionStringFile_Click"
                      Margin="6,0,0,0" Padding="12,6"/>
            </Grid>
            <ComboBox Grid.Column="1" ItemsSource="{Binding DatabaseTypes}" 
                      SelectedItem="{Binding DatabaseType}"
                      Width="120" Height="32"
                      Margin="8,0,0,0"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- 2. Players SQL File Selection -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“ Players SQL Query File" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Select a SQL file containing the query to extract player data"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Text="{Binding SqlFilePath}" 
                     Watermark="Path to SQL file..."
                     IsReadOnly="True" Height="32"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseSqlFile_Click"
                    Margin="6,0,0,0" Padding="12,6"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- 3. Teams Section (Optional) -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <!-- Use Teams checkbox + explanatory text -->
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="ðŸ‘¥ Teams (Optional)" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <CheckBox Content="Use Teams" 
                      IsChecked="{Binding UseTeams}"
                      IsEnabled="{Binding TeamsLoaded}"/>
          </StackPanel>
          <TextBlock Text="Extract teams to enable team selection dropdown and auto-generate output filename"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>

          <!-- Teams SQL File -->
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding TeamsSqlFilePath}" 
                     Watermark="Path to teams SQL file (optional)..."
                     IsReadOnly="True" Height="32"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseTeamsSqlFile_Click"
                    Margin="6,0,0,0" Padding="12,6"/>
            <Button Grid.Column="2" Content="Extract Teams"
                    Click="ExtractTeams_Click"
                    IsEnabled="{Binding !IsExtractingTeams}"
                    Margin="6,0,0,0" Padding="12,6"
                    Background="{DynamicResource PrimaryBrush}" Foreground="{DynamicResource HeaderTextBrush}"/>
          </Grid>

          <!-- Or Load Existing Teams CSV -->
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding TeamsCsvPath}" 
                     Watermark="Or load existing teams.csv..."
                     IsReadOnly="True" Height="32"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseTeamsCsvFile_Click"
                    Margin="6,0,0,0" Padding="12,6"/>
            <Button Grid.Column="2" Content="Load"
                    Command="{Binding LoadTeamsFromCsvCommand}"
                    IsEnabled="{Binding !IsExtractingTeams}"
                    Margin="6,0,0,0" Padding="12,6"/>
          </Grid>

          <!-- Teams Status -->
          <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding TeamsLoaded}">
            <TextBlock Text="âœ“" FontSize="12" Foreground="{DynamicResource SuccessBrush}"/>
            <TextBlock Text="{Binding AvailableTeams.Count, StringFormat='{}{0} teams loaded'}"
                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <Button Content="Clear" 
                    Command="{Binding ClearTeamsSelectionCommand}"
                    Padding="8,2" FontSize="10"/>
          </StackPanel>

          <!-- Progress for teams extraction -->
          <ProgressBar IsIndeterminate="True" 
                       IsVisible="{Binding IsExtractingTeams}"
                       Height="4"/>
        </StackPanel>
      </Border>

      <!-- 4. Team Selection/Team ID -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <!-- Team Dropdown (visible when teams are loaded and UseTeams is true) -->
          <StackPanel IsVisible="{Binding UseTeams}">
            <TextBlock Text="ðŸ·ï¸ Select Team" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <ComboBox ItemsSource="{Binding AvailableTeams}"
                      SelectedItem="{Binding SelectedTeam}"
                      HorizontalAlignment="Stretch" Height="32">
              <ComboBox.ItemTemplate>
                <DataTemplate>
                  <TextBlock Text="{Binding DisplayName}"/>
                </DataTemplate>
              </ComboBox.ItemTemplate>
            </ComboBox>
          </StackPanel>
          
          <!-- Manual Team ID (visible when teams are not used) -->
          <StackPanel IsVisible="{Binding !UseTeams}">
            <TextBlock Text="ðŸ·ï¸ Team ID" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <NumericUpDown Value="{Binding TeamId}" 
                          Minimum="0" Maximum="9999999"
                          HorizontalAlignment="Stretch" Height="32"/>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Output File Name (auto-generated when team selected) -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="ðŸ“„ Output File Name" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <TextBlock Text="(auto-generated from team selection)" 
                       FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"
                       IsVisible="{Binding UseTeams}"
                       VerticalAlignment="Center"/>
          </StackPanel>
          <TextBox Text="{Binding OutputFileName}" 
                   Watermark="players.csv"
                   Height="32"
                   IsReadOnly="{Binding UseTeams}"
                   Background="{DynamicResource InputBackgroundBrush}"
                   Foreground="{DynamicResource PrimaryTextBrush}"/>
        </StackPanel>
      </Border>

      <!-- Output Folder -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“‚ Output Folder" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Choose where the extracted CSV file will be created"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Text="{Binding OutputDirectory}"
                     Watermark="Path to output folder..."
                     IsReadOnly="True" Height="32"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse"
                    Click="BrowseOutputDirectory_Click"
                    Margin="6,0,0,0" Padding="12,6"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Execute Button -->
      <Button Content="â–¶ Extract Data" 
              Click="ExecuteExtract_Click"
              IsEnabled="{Binding !IsProcessing}"
              Background="{DynamicResource SuccessBrush}" Foreground="{DynamicResource HeaderTextBrush}"
              FontSize="14" Padding="20,8"
              HorizontalAlignment="Center"/>

      <!-- Status -->
      <Border Background="{DynamicResource InfoBackgroundBrush}" CornerRadius="8" Padding="12" 
              IsVisible="{Binding ProcessingStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
        <StackPanel Spacing="6">
          <TextBlock Text="{Binding ProcessingStatus}" 
                     FontSize="13" TextWrapping="Wrap"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
          <ProgressBar IsIndeterminate="True" 
                       IsVisible="{Binding IsProcessing}"
                       Height="4"/>
        </StackPanel>
      </Border>

      <!-- Run Log -->
      <Expander Header="Run Log" IsExpanded="False" HorizontalAlignment="Stretch"
                Background="{DynamicResource SurfaceBrush}">
        <Border Background="{DynamicResource LogBackgroundBrush}" CornerRadius="8" Padding="10" Margin="0,6,0,0" HorizontalAlignment="Stretch">
          <StackPanel Spacing="6" HorizontalAlignment="Stretch">
            <Button Content="Copy Log" Click="CopyRunLog_Click" HorizontalAlignment="Left" Padding="10,5"/>
            <ScrollViewer Height="120" HorizontalAlignment="Stretch" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding LogLines}" HorizontalAlignment="Stretch">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <SelectableTextBlock Text="{Binding}" FontSize="12" TextWrapping="NoWrap"
                                         Foreground="{DynamicResource PrimaryTextBrush}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Success indicator -->
      <Border Background="{DynamicResource SuccessBackgroundBrush}" CornerRadius="8" Padding="12"
              IsVisible="{Binding IsComplete}">
        <StackPanel Orientation="Horizontal" Spacing="6">
          <TextBlock Text="âœ“" FontSize="18" Foreground="{DynamicResource SuccessBrush}"/>
          <TextBlock Text="{Binding PlayersExtracted, StringFormat='Successfully extracted {0} players'}"
                     FontSize="13" Foreground="{DynamicResource SuccessDarkBrush}"/>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
