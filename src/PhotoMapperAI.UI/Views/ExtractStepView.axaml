<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PhotoMapperAI.UI.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="PhotoMapperAI.UI.Views.ExtractStepView"
             x:DataType="vm:ExtractStepViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Design.DataContext>
    <vm:ExtractStepViewModel/>
  </Design.DataContext>

  <ScrollViewer>
    <StackPanel Margin="24" Spacing="20">
      <!-- Header -->
      <TextBlock Text="Step 1: Extract Player Data" 
                 FontSize="24" FontWeight="Bold" 
                 Foreground="{DynamicResource PrimaryBrush}"/>
      <TextBlock Text="Extract player data from your database to a CSV file. This CSV will be used in the next steps."
                 FontSize="14" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>

      <Separator Margin="0,8" Background="{DynamicResource DividerBrush}"/>

      <!-- SQL File Selection -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16">
        <StackPanel Spacing="12">
          <TextBlock Text="ðŸ“ SQL Query File" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Select a SQL file containing the query to extract player data"
                     FontSize="12" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Text="{Binding SqlFilePath}" 
                     Watermark="Path to SQL file..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseSqlFile_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Connection String File -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16">
        <StackPanel Spacing="12">
          <TextBlock Text="ðŸ” Connection String File" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Select a file containing your database connection string (kept separate for security)"
                     FontSize="12" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Text="{Binding ConnectionStringPath}" 
                     Watermark="Path to connection string file..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseConnectionStringFile_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Database Type and Team ID -->
      <Grid ColumnDefinitions="*,*" Margin="0,8">
        <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16" Margin="0,0,8,0">
          <StackPanel Spacing="12">
            <TextBlock Text="ðŸ—„ï¸ Database Type" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <ComboBox ItemsSource="{Binding DatabaseTypes}" 
                      SelectedItem="{Binding DatabaseType}"
                      HorizontalAlignment="Stretch" Height="36"/>
          </StackPanel>
        </Border>

        <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16" Margin="8,0,0,0">
          <StackPanel Spacing="12">
            <TextBlock Text="ðŸ·ï¸ Team ID" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <NumericUpDown Value="{Binding TeamId}" 
                          Minimum="0" Maximum="9999999"
                          HorizontalAlignment="Stretch" Height="36"/>
          </StackPanel>
        </Border>
      </Grid>

      <!-- Output File Name -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16">
        <StackPanel Spacing="12">
          <TextBlock Text="ðŸ“„ Output File Name" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBox Text="{Binding OutputFileName}" 
                   Watermark="players.csv"
                   Height="36"
                   Background="{DynamicResource InputBackgroundBrush}"
                   Foreground="{DynamicResource PrimaryTextBrush}"/>
        </StackPanel>
      </Border>

      <!-- Output Folder -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16">
        <StackPanel Spacing="12">
          <TextBlock Text="ðŸ“‚ Output Folder" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Choose where the extracted CSV file will be created"
                     FontSize="12" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Text="{Binding OutputDirectory}"
                     Watermark="Path to output folder..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse"
                    Click="BrowseOutputDirectory_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Execute Button -->
      <Button Content="â–¶ Extract Data" 
              Click="ExecuteExtract_Click"
              IsEnabled="{Binding !IsProcessing}"
              Background="{DynamicResource SuccessBrush}" Foreground="{DynamicResource HeaderTextBrush}"
              FontSize="16" Padding="24,12"
              HorizontalAlignment="Center"/>

      <!-- Status -->
      <Border Background="{DynamicResource InfoBackgroundBrush}" CornerRadius="8" Padding="16" 
              IsVisible="{Binding ProcessingStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
        <StackPanel Spacing="8">
          <TextBlock Text="{Binding ProcessingStatus}" 
                     FontSize="14" TextWrapping="Wrap"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
          <ProgressBar IsIndeterminate="True" 
                       IsVisible="{Binding IsProcessing}"
                       Height="4"/>
        </StackPanel>
      </Border>

      <!-- Run Log -->
      <Expander Header="Run Log" IsExpanded="False" HorizontalAlignment="Stretch"
                Background="{DynamicResource SurfaceBrush}">
        <Border Background="{DynamicResource LogBackgroundBrush}" CornerRadius="8" Padding="12" Margin="0,8,0,0" HorizontalAlignment="Stretch">
          <StackPanel Spacing="8" HorizontalAlignment="Stretch">
            <Button Content="Copy Log" Click="CopyRunLog_Click" HorizontalAlignment="Left" Padding="12,6"/>
            <ScrollViewer Height="160" HorizontalAlignment="Stretch" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding LogLines}" HorizontalAlignment="Stretch">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <SelectableTextBlock Text="{Binding}" FontSize="12" TextWrapping="NoWrap"
                                         Foreground="{DynamicResource PrimaryTextBrush}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Success indicator -->
      <Border Background="{DynamicResource SuccessBackgroundBrush}" CornerRadius="8" Padding="16"
              IsVisible="{Binding IsComplete}">
        <StackPanel Orientation="Horizontal" Spacing="8">
          <TextBlock Text="âœ“" FontSize="20" Foreground="{DynamicResource SuccessBrush}"/>
          <TextBlock Text="{Binding PlayersExtracted, StringFormat='Successfully extracted {0} players'}"
                     FontSize="14" Foreground="{DynamicResource SuccessDarkBrush}"/>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
