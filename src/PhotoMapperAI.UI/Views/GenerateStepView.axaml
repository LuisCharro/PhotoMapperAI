<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PhotoMapperAI.UI.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="PhotoMapperAI.UI.Views.GenerateStepView"
             x:DataType="vm:GenerateStepViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Design.DataContext>
    <vm:GenerateStepViewModel/>
  </Design.DataContext>

  <Grid>
    <ScrollViewer>
    <StackPanel Margin="16" Spacing="12">
      <!-- Header -->
      <TextBlock Text="Step 3: Generate Portrait Photos" 
                 FontSize="20" FontWeight="Bold" 
                 Foreground="{DynamicResource PrimaryBrush}"/>
      <TextBlock Text="Generate portrait photos from full-body images using AI face detection. Output files will be named by PlayerId."
                 FontSize="13" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>

      <Separator Margin="0,4" Background="{DynamicResource DividerBrush}"/>

      <!-- CSV File Selection -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“„ Input CSV File" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Select the CSV file with photo mappings from Step 2"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding InputCsvPath}" 
                     Watermark="Path to CSV file..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseCsvFile_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
            <Button Grid.Column="2" Content="Clear"
                    Command="{Binding ClearInputCsvCommand}"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Photos Directory -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“ Source Photos Directory" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Directory containing the original player photos"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding PhotosDirectory}" 
                     Watermark="Path to photos directory..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowsePhotosDirectory_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
            <Button Grid.Column="2" Content="Clear"
                    Command="{Binding ClearPhotosDirectoryCommand}"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Photo Grid Preview -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="ðŸ–¼ï¸ Photo Grid Preview" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Content="Load Grid"
                    Command="{Binding LoadPhotoGridCommand}"
                    IsEnabled="{Binding !IsLoadingPhotoGrid}"
                    Padding="12,6"/>
            <ProgressBar IsIndeterminate="True"
                         Width="60"
                         Height="4"
                         IsVisible="{Binding IsLoadingPhotoGrid}"
                         VerticalAlignment="Center"/>
          </StackPanel>
          <TextBlock Text="{Binding PreviewStatus}"
                     FontSize="11"
                     Foreground="{DynamicResource SecondaryTextBrush}"
                     TextWrapping="Wrap"/>
          
          <!-- Grid Display -->
          <ScrollViewer MaxHeight="400" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding PhotoPreviewItems}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel Orientation="Horizontal"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Background="{DynamicResource CardBrush}" 
                          CornerRadius="6" 
                          Padding="8" 
                          Margin="4"
                          BorderBrush="{DynamicResource BorderBrush}"
                          BorderThickness="1"
                          Width="180"
                          PointerPressed="PhotoItem_Click"
                          Cursor="Hand">
                    <StackPanel Spacing="6">
                      <!-- Photo Thumbnail -->
                      <Image Source="{Binding Thumbnail}"
                             Height="100"
                             Stretch="Uniform"
                             HorizontalAlignment="Center"/>
                      
                      <!-- Filename -->
                      <TextBlock Text="{Binding FileName}"
                                 FontSize="10"
                                 Foreground="{DynamicResource SecondaryTextBrush}"
                                 TextTrimming="CharacterEllipsis"
                                 ToolTip.Tip="{Binding FileName}"/>
                      
                      <!-- Mapping Status -->
                      <Border Background="{Binding HasValidMapping, Converter={StaticResource BoolToStatusBackgroundConverter}}"
                              CornerRadius="3" Padding="4,2">
                        <TextBlock Text="{Binding StatusText}"
                                   FontSize="10"
                                   TextWrapping="Wrap"
                                   HorizontalAlignment="Center"/>
                      </Border>
                      
                      <!-- Player ID (if available) -->
                      <StackPanel Orientation="Horizontal" Spacing="4"
                                  IsVisible="{Binding PlayerId, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Text="Player ID:" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
                        <TextBlock Text="{Binding PlayerId}" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
                      </StackPanel>
                      
                      <!-- Confidence Score -->
                      <StackPanel Orientation="Horizontal" Spacing="4"
                                  IsVisible="{Binding Confidence, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Text="Confidence:" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
                        <TextBlock Text="{Binding Confidence, StringFormat={}{0:P0}}" FontSize="10" Foreground="{DynamicResource PrimaryTextBrush}"/>
                      </StackPanel>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </StackPanel>
      </Border>

      <!-- Output Directory -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“‚ Output Directory" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Directory where portrait photos will be saved"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding OutputDirectory}" 
                     Watermark="Path to output directory..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse" 
                    Click="BrowseOutputDirectory_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
            <Button Grid.Column="2" Content="Clear"
                    Command="{Binding ClearOutputDirectoryCommand}"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Face Detection Model -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ¤– Face Detection Model" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="OpenCV is recommended (fastest). Ollama vision models are slower."
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>

          <TabControl SelectedIndex="{Binding SelectedFaceModelTierIndex}">
            <TabItem Header="Recommended">
              <StackPanel Spacing="6" Margin="0,6,0,0">
                <TextBlock Text="Fast and stable for portrait generation."
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                <ComboBox ItemsSource="{Binding RecommendedFaceDetectionModels}"
                          SelectedItem="{Binding FaceDetectionModel, Mode=OneWay}"
                          SelectionChanged="FaceModelSelectionChanged"
                          HorizontalAlignment="Left" Width="360" Height="36"/>
              </StackPanel>
            </TabItem>

            <TabItem Header="Local Vision (Ollama)">
              <StackPanel Spacing="6" Margin="0,6,0,0">
                <TextBlock Text="Runs locally through Ollama (slower, higher CPU/RAM)."
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                <ComboBox ItemsSource="{Binding LocalVisionFaceDetectionModels}"
                          SelectedItem="{Binding FaceDetectionModel, Mode=OneWay}"
                          SelectionChanged="FaceModelSelectionChanged"
                          HorizontalAlignment="Left" Width="360" Height="36"/>
              </StackPanel>
            </TabItem>

            <TabItem Header="Advanced">
              <StackPanel Spacing="6" Margin="0,6,0,0">
                <TextBlock Text="Fallback/troubleshooting detectors."
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                <ComboBox ItemsSource="{Binding AdvancedFaceDetectionModels}"
                          SelectedItem="{Binding FaceDetectionModel, Mode=OneWay}"
                          SelectionChanged="FaceModelSelectionChanged"
                          HorizontalAlignment="Left" Width="360" Height="36"/>
              </StackPanel>
            </TabItem>

            <TabItem Header="Paid (coming soon)">
              <StackPanel Spacing="6" Margin="0,6,0,0">
                <TextBlock Text="Paid API-based face detection providers are not wired yet."
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>
                <TextBlock Text="Configured models from appsettings.json (UiModelLists.GeneratePaidModels):"
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                <ComboBox ItemsSource="{Binding PaidFaceDetectionModels}"
                          IsEnabled="False"
                          HorizontalAlignment="Left" Width="420" Height="36"/>
                <TextBlock Text="For now use OpenCV or Ollama models."
                           FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
              </StackPanel>
            </TabItem>
          </TabControl>

          <CheckBox Content="Download missing OpenCV DNN files"
                    IsChecked="{Binding DownloadOpenCvModels}"/>

          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Check Model"
                    Command="{Binding CheckFaceModelCommand}"
                    IsEnabled="{Binding !IsCheckingModel}"
                    Padding="12,6"/>
            <ProgressBar IsIndeterminate="True"
                         Width="80"
                         Height="4"
                         IsVisible="{Binding IsCheckingModel}"/>
          </StackPanel>

          <TextBlock Text="{Binding ModelDiagnosticStatus}"
                     FontSize="11"
                     Foreground="{DynamicResource SecondaryTextBrush}"
                     TextWrapping="Wrap"
                     IsVisible="{Binding ModelDiagnosticStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

          <Expander Header="Advanced diagnostics" IsExpanded="False"
                    Background="{DynamicResource SurfaceBrush}">
            <StackPanel Spacing="6" Margin="0,6,0,0">
              <CheckBox Content="Write debug artifact JSON per variant"
                        IsChecked="{Binding WriteDebugArtifacts}"/>
            </StackPanel>
          </Expander>
        </StackPanel>
      </Border>

      <!-- Size Profile Settings -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ“ Size Profile (Optional)" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Use a size profile for multiple output sizes in one run (e.g., 34x50, 67x100, 100x150, 200x300)"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <Grid ColumnDefinitions="*,Auto,Auto">
            <TextBox Grid.Column="0" Text="{Binding SizeProfilePath}"
                     Watermark="Path to size profile JSON..."
                     IsReadOnly="True" Height="36"
                     Background="{DynamicResource InputBackgroundBrush}"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
            <Button Grid.Column="1" Content="Browse"
                    Click="BrowseSizeProfileFile_Click"
                    Margin="8,0,0,0" Padding="16,8"/>
            <Button Grid.Column="2" Content="Clear"
                    Command="{Binding ClearSizeProfilePathCommand}"
                    Margin="8,0,0,0" Padding="16,8"/>
          </Grid>
          <CheckBox Content="Generate all profile sizes"
                    IsChecked="{Binding AllSizes}"
                    IsEnabled="{Binding CanUseAllSizes}"
                    ToolTip.Tip="When enabled, generates portraits for all sizes defined in the profile"/>
        </StackPanel>
      </Border>

      <!-- Output Profile Settings -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸ“ Output Profile" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <TextBlock Text="(Optional)" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource SecondaryTextBrush}"/>
          </StackPanel>
          <TextBlock Text="Quickly switch between predefined output locations without typing full paths."
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>
          <Grid ColumnDefinitions="Auto,*,Auto">
            <TextBlock Grid.Column="0" Text="Environment:" VerticalAlignment="Center" Margin="0,0,12,0"
                       Foreground="{DynamicResource PrimaryTextBrush}"/>
            <ComboBox Grid.Column="1" ItemsSource="{Binding OutputProfiles}"
                      SelectedItem="{Binding OutputProfile}"
                      Width="180" Height="36" HorizontalAlignment="Left"/>
          </Grid>
          <StackPanel Spacing="3">
            <TextBlock Text="Available profiles:" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <TextBlock Text="â€¢ none - Use the Output Directory path directly" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <TextBlock Text="â€¢ test - Uses test output path from config" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <TextBlock Text="â€¢ prod - Uses prod output path from config" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <TextBlock Text="Configure in appsettings.json under OutputProfiles section" FontSize="9" FontStyle="Italic" Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,3,0,0"/>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Portrait Settings -->
      <Grid ColumnDefinitions="*,*,*" Margin="0,4">
        <!-- Width -->
        <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12" Margin="0,0,6,0">
          <StackPanel Spacing="8">
            <TextBlock Text="Width (px)" FontSize="13" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <NumericUpDown Value="{Binding PortraitWidth}" 
                          Minimum="50" Maximum="1000"
                          IsEnabled="{Binding ManualSizeControlsEnabled}"
                          HorizontalAlignment="Stretch" Height="36"/>
          </StackPanel>
        </Border>

        <!-- Height -->
        <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12" Margin="3,0">
          <StackPanel Spacing="8">
            <TextBlock Text="Height (px)" FontSize="13" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <NumericUpDown Value="{Binding PortraitHeight}" 
                          Minimum="50" Maximum="1500"
                          IsEnabled="{Binding ManualSizeControlsEnabled}"
                          HorizontalAlignment="Stretch" Height="36"/>
          </StackPanel>
        </Border>

        <!-- Format -->
        <Border Grid.Column="2" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12" Margin="6,0,0,0">
          <StackPanel Spacing="8">
            <TextBlock Text="Format" FontSize="13" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <ComboBox ItemsSource="{Binding ImageFormats}" 
                      SelectedItem="{Binding ImageFormat}"
                      HorizontalAlignment="Stretch" Height="36"/>
          </StackPanel>
        </Border>
      </Grid>

      <!-- Portrait Only Option -->
      <CheckBox Content="Portrait Only (skip face detection, use existing results)" 
                IsChecked="{Binding PortraitOnly}"
                Margin="0,4"/>

      <!-- Placeholder Image -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸ–¼ï¸ Use Placeholder Images" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Copy placeholder images when no photo is found for a player (placeholder paths come from size profile)"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <CheckBox Content="Use placeholder images when player has no photo"
                    IsChecked="{Binding UsePlaceholderImages}"
                    IsEnabled="{Binding CanUseAllSizes}"/>
        </StackPanel>
      </Border>

      <!-- Single Player Filter -->
      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock Text="ðŸŽ¯ Single Player Filter (Optional)" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
          <TextBlock Text="Process only a specific player by ID (PlayerId or ExternalId from CSV)"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
          <TextBox Text="{Binding OnlyPlayerId}"
                   Watermark="Enter Player ID to process only that player..."
                   Height="36"
                   Background="{DynamicResource InputBackgroundBrush}"
                   Foreground="{DynamicResource PrimaryTextBrush}"/>
        </StackPanel>
      </Border>

      <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
        <!-- Preview Portrait -->
        <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
          <StackPanel Spacing="8">
            <TextBlock Text="ðŸ§ª Preview Portrait" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <TextBlock Text="{Binding PreviewPlayerLabel}"
                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"
                       TextWrapping="Wrap"/>
            <TextBlock Text="{Binding PreviewStatus}"
                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"
                       TextWrapping="Wrap"/>
            <Border Background="{DynamicResource LogBackgroundBrush}" CornerRadius="6" Padding="8"
                    IsVisible="{Binding PreviewImage, Converter={x:Static ObjectConverters.IsNotNull}}">
              <Image Source="{Binding PreviewImage}"
                     Height="200"
                     Stretch="Uniform"/>
            </Border>
          </StackPanel>
        </Border>

        <!-- Crop Offset Presets -->
        <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
          <StackPanel Spacing="8">
            <TextBlock Text="ðŸŽ›ï¸ Crop Offsets" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}"/>
            <TextBlock Text="Adjust horizontal/vertical offsets (percent of crop size)."
                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
            <StackPanel Spacing="5">
              <TextBlock Text="Preset" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
              <ComboBox ItemsSource="{Binding CropOffsetPresets}"
                        SelectedItem="{Binding SelectedCropOffsetPreset}"
                        Height="36">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Name}"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </StackPanel>
            <StackPanel Spacing="5">
              <TextBlock Text="Horizontal offset (%)" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                          <Slider Minimum="-20" Maximum="20" TickFrequency="1" IsSnapToTickEnabled="True"
                            Value="{Binding CropOffsetXPercent, Mode=TwoWay}"
                            ValueChanged="CropOffsetSlider_ValueChanged"/>
              <TextBlock Text="{Binding CropOffsetXPercent, StringFormat='Current: {0:0}%'}"
                         FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
            </StackPanel>
            <StackPanel Spacing="5">
              <TextBlock Text="Vertical offset (%)" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                          <Slider Minimum="-20" Maximum="20" TickFrequency="1" IsSnapToTickEnabled="True"
                            Value="{Binding CropOffsetYPercent, Mode=TwoWay}"
                            ValueChanged="CropOffsetSlider_ValueChanged"/>
              <TextBlock Text="{Binding CropOffsetYPercent, StringFormat='Current: {0:0}%'}"
                         FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="10">
              <Button Content="Generate Preview"
                      Command="{Binding GeneratePreviewCommand}"
                      IsEnabled="{Binding !IsPreviewing}"
                      Padding="10,5"/>
              <Button Content="Save Preset" Command="{Binding SaveCropOffsetPresetCommand}" Padding="10,5"/>
            </StackPanel>
            <CheckBox Content="Auto preview on offset change"
                      IsChecked="{Binding AutoPreviewEnabled}"
                      FontSize="11"
                      Foreground="{DynamicResource SecondaryTextBrush}"/>
            <TextBlock Text="{Binding CropOffsetStatus}"
                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"
                       VerticalAlignment="Center"/>
          </StackPanel>
        </Border>
      </Grid>

      <!-- Execute / Cancel Buttons -->
      <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
        <Button Content="â–¶ Generate Portraits" 
                Command="{Binding ExecuteGenerateCommand}"
                IsEnabled="{Binding !IsProcessing}"
                Background="{DynamicResource SuccessBrush}" Foreground="{DynamicResource HeaderTextBrush}"
                FontSize="14" Padding="20,8"/>
        <Button Content="â–  Cancel"
                Command="{Binding CancelGenerateCommand}"
                IsVisible="{Binding IsProcessing}"
                Background="{DynamicResource ErrorBrush}" Foreground="{DynamicResource HeaderTextBrush}"
                FontSize="14" Padding="20,8"/>
      </StackPanel>

      <!-- Progress -->
      <Border Background="{DynamicResource InfoBackgroundBrush}" CornerRadius="8" Padding="12" 
              IsVisible="{Binding IsProcessing}">
        <StackPanel Spacing="6">
          <TextBlock Text="{Binding ProcessingStatus}" 
                     FontSize="13" TextWrapping="Wrap"
                     Foreground="{DynamicResource PrimaryTextBrush}"/>
          <ProgressBar Value="{Binding Progress}" 
                       Maximum="100"
                       Height="6"/>
        </StackPanel>
      </Border>

      <!-- Status -->
      <Border Background="{DynamicResource InfoBackgroundBrush}" CornerRadius="8" Padding="12" 
              IsVisible="{Binding ProcessingStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
        <TextBlock Text="{Binding ProcessingStatus}" 
                   FontSize="13" TextWrapping="Wrap"
                   Foreground="{DynamicResource PrimaryTextBrush}"/>
      </Border>

      <!-- Run Log -->
      <Expander Header="Run Log" IsExpanded="False" HorizontalAlignment="Stretch"
                Background="{DynamicResource SurfaceBrush}">
        <Border Background="{DynamicResource LogBackgroundBrush}" CornerRadius="8" Padding="10" Margin="0,6,0,0" HorizontalAlignment="Stretch">
          <StackPanel Spacing="6" HorizontalAlignment="Stretch">
            <Button Content="Copy Log" Click="CopyRunLog_Click" HorizontalAlignment="Left" Padding="10,5"/>
            <ScrollViewer Height="120" HorizontalAlignment="Stretch" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding LogLines}" HorizontalAlignment="Stretch">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <SelectableTextBlock Text="{Binding}" FontSize="12" TextWrapping="NoWrap"
                                         Foreground="{DynamicResource PrimaryTextBrush}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Success indicator -->
      <Border Background="{DynamicResource SuccessBackgroundBrush}" CornerRadius="8" Padding="12"
              IsVisible="{Binding IsComplete}">
        <StackPanel Spacing="6">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="âœ“" FontSize="18" Foreground="{DynamicResource SuccessBrush}"/>
            <TextBlock Text="{Binding PortraitsGenerated, StringFormat='Successfully generated {0} portraits'}"
                       FontSize="13" Foreground="{DynamicResource SuccessDarkBrush}"/>
          </StackPanel>
          <TextBlock Text="{Binding PortraitsFailed, StringFormat='Failed: {0}'}"
                     FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"
                     IsVisible="{Binding PortraitsFailed}"/>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
  </Grid>
</UserControl>
